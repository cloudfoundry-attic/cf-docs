# Bosh vSphere CPI


Example cloud properties:

```
cloud:
  plugin: vsphere
  properties:
	...
    vcenters:
      - host: vcenter-host.example.com
        user: admin
        password: secret
        datacenters:
          - name: DATACENTER_NAME
            vm_folder:       VMs
            template_folder: Templates
            disk_path:       Disks
            datastore_pattern:            datastore
            persistent_datastore_pattern: datastore
            allow_mixed_datastores: true
            clusters:
              - CLUSTER_NAME:
                  resource_pool: RESOURCE_POOL_NAME
```
* `vcenters`
	* `host` - the hostname or ip address of the vCenter server
	* `user` - the vCenter username
	* `password` - the vCenter password for the above user
	* `datacenters`
		* `name` - the name of the datacenter you wish to use
		* `vm_folder` - inventory folder where VMs will be created
		* `template_folder` - inventory folder where stemcells will be created
		* `disk_path` - where VMDKs are stored on persistent datastores
		* `datastore_pattern` - a real Ruby RegEx which defines where VMs and ephemeral disks are stored
		* `persistent_datastore_pattern` - a real Ruby RegEx which defined where persistent disks are stored
		* `allow_mixed_datastores` - required to be true if datastore\_pattern and persistent\_datastore\_pattern RegExs overlap

		* `clusters`
  			* `CLUSTER_NAME` - the name of the cluster in your datacenter
  				* `resource_pool` - the name of the resource pool used for allocating VMs


### vCenters

The bosh vSphere CPI does not support multiple vCenters, and will error if more
than one is defined in the `vcenters` list in the manifest.

### VMs

VMs have randomly generated cloud identifiers, in the format `"vm-#{SecureRandom.uuid}"`. They are stored on a datacenter as follows:

`datacenter.name/vm/vm_folder.name/vm_cid`

e.g.

 `TEST_DATACENTER/vm/58bc710b-aec7-41f6-bb78-7d65f8033e51/vm-f050dbdb-ddcf-4524-b6d8-fad1135c6f7e`

Your datacenter will be queried for the path above to try and find a matching VM.

There is nothing in the CPI that prevents using an id generated by the cloud for the cloud id. Indeed, the AWS CPI uses the instance ids generated on AWS
for cloud ids. The create_vm() CPI call returns the cid of the created VM, so it's up to the CPI implementor to decide what to use for cloud id.

Although it's technically possible to use the instanceUuid on vSphere (much like how we use AWS instance ids), it's worth noting that this breaks backwards compatibility and would require a fairly hefty migration. This would open up the possibility of allowing an operator to move a VM out of its containing folder on a datacenter, as it would be possible to identify a VM independent of its inventory location.

### Networks

Networks are uniquely identified by datacenter and network name (which must be unique within the datacenter).

### Datastores

Datastores are identified by their name and are matched by a regular expression that matches against that name. For example, consider the following datastores in folders:

- `/foo/bar/datastore1`
- `/foo/bar/anothername`
- `/foo/baz/datastore1`

The name of datastore is the last part of each line above, e.g. 'datastore1'. An operator may choose to select both `/foo/bar/datastore1` and `/foo/baz/datastore1` with the regular expression 'datastore' or even 'datastore1'. They cannot, however, select both `/foo/bar/datastore1` and `/foo/bar/anothername` by using a regular expression that matches against directory structure, e.g. `/foo/bar`.

Ephemeral and persistent datastores are consumed before shared datastores.

#### Datastore Paths

Persistent disks are stored on datastores in the following paths:

`/<datacenter disk path from manifest>/disk-<random disk uuid>.vmdk`

#### Linked Clones

The vSphere CPI uses linked clones by default. Linked clones require the clone to be on the same datastore as the source so stemcells are automatically copied to each datastore that their clones will be on. These stemcells look like `sc-<uuid> / <datastore managed object id>` in the inventory. In the datastore browser the "/" will be quoted to "%2f".

### Clusters

Each datacenter can have multiple clusters in the cloud properties.

A cluster is identified by its name and its datacenter. Its location within folders in each datacenter does not matter.

In vSphere, cluster names do not need to be unique per datacenter, only their paths needs to be unique. The current vSphere CPI code does not handle this and would only see one cluster if two had the same name.

Clusters do not have any unique ID like a VM's instanceUuid.

#### VM Placement

When placing a VM, a cluster is chosen (along with a datastore) based on the VM's memory, ephemeral disk, and persistent disk requirements.

VMs are placed on clusters and datastores based on a weighted random algorithm. The weights are calculated by how many times the requested memory, ephemeral and persistent disk could fit on the cluster.

During VM placement local datastores and shared datastores are not treated differently. All datastores registered on a cluster are treated the same.

##### Locality

When recreating an existing VM, the CPI tries to create it in a cluster and datastore that are near the largest of its existing persistent disks.

### Datacenters

The vSphere CPI only supports a single datacenter and errors if more than one is defined in the manifest. It is identified by name.

The current code will not work with a datacenter inside a folder.